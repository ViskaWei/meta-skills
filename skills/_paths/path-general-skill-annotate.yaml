id: path-general-skill-annotate
name: "Batch Skill Annotation"
domain: harness
version: 1
outcome: "Unannotated L2 blocks → Auto-classify → Preview → PAUSE → Apply frontmatter → Rebuild index → Verified"
source: "Batch auto-annotate missing YAML frontmatter on L2 capability blocks. Addresses ghost caps in capability-index.yaml."
execution_mode: team
parallel_groups: []

inputs:
  required: []
  optional:
    - scope: "Target scope: all (default), stage:<name>, or specific file paths"
    - dry-run: "Preview only, don't apply (default: false)"

steps:
  # === Phase 1: Scan (discover) ===
  - id: scan-unannotated
    stage: discover
    capabilities_needed: [cap-intake-brief]
    output_type: intake-manifest
    description: >
      Scan all L2 block files for missing or incomplete frontmatter:
      (1) Find all .md files in _stages/*/sub/
      (2) Check each for YAML frontmatter with cap_id, input_types, output_types
      (3) Cross-reference with capability-index.yaml ghost entries (commented out lines)
      (4) Cross-reference with skills-registry.yaml for matching entries
      (5) Produce manifest: { file, has_frontmatter, has_cap_id, in_index, in_registry, status }
      Status: annotated | partial | ghost | missing

  # === Phase 2: Classify (discover) ===
  - id: classify-blocks
    stage: discover
    capabilities_needed: [cap-compare-option-matrix]
    output_type: option-matrix
    gate_requires: [intake-manifest]
    description: >
      For each unannotated block, auto-classify:
      (1) Read block content to determine intent and I/O contract
      (2) Match verb from content to verbs.yaml (18 canonical verbs)
      (3) Match object from content to objects.yaml (88 canonical objects)
      (4) Propose cap_id following cap-<verb>-<object> convention
      (5) Propose input_types and output_types from artifact-types.yaml
      (6) Assign leveling tag (Gx-Vy-Pz-Mk)
      (7) Determine stage from file path (_stages/<stage>/sub/)
      Produce classification table:
      | File | Proposed cap_id | verb | object | inputs | outputs | leveling |

  # === Phase 3: Preview + Confirm (decide) ===
  - id: preview-annotations
    stage: decide
    capabilities_needed: [cap-decide-adr]
    output_type: adr
    gate_requires: [option-matrix]
    description: >
      PAUSE: Present classification table to user.
      For each proposed annotation, show:
      - File path and current state
      - Proposed cap_id and rationale
      - Proposed frontmatter YAML block
      User can approve all, approve subset, or modify proposals.
      If --dry-run, stop here after preview.

  # === Phase 4: Apply (build) ===
  - id: apply-frontmatter
    stage: build
    capabilities_needed: [cap-build-implementation]
    output_type: patched-artifact
    gate_requires: [adr]
    description: >
      For each approved annotation:
      (1) Add/update YAML frontmatter block at top of .md file
      (2) Add entry to skills-registry.yaml under correct stage
      (3) Ensure cap_id is unique (no duplicates)
      Format:
      ```yaml
      ---
      cap_id: cap-<verb>-<object>
      input_types: [<type1>]
      output_types: [<type2>]
      leveling: Gx-Vy-Pz-Mk
      ---
      ```

  - id: rebuild-index
    stage: build
    capabilities_needed: [cap-build-implementation]
    output_type: patched-artifact
    gate_requires: [patched-artifact]
    description: >
      Rebuild capability-index.yaml:
      (1) Run tools/build_capability_index.sh
      (2) Verify new entries appear (not commented out)
      (3) Verify no ghost entries remain for annotated blocks

  # === Phase 5: Verify (verify) ===
  - id: verify-annotations
    stage: verify
    capabilities_needed: [cap-decide-quality-gate]
    output_type: gate-verdict
    gate_requires: [patched-artifact]
    description: >
      Full verification:
      (1) tools/validate_contracts.sh — all annotated blocks PASS
      (2) tools/validate_aliases.sh — no alias conflicts
      (3) capability-index.yaml — new entries present and correct
      (4) skills-registry.yaml — new entries present
      (5) tools/setup.sh — deployment succeeds
      (6) No regressions: previously-annotated blocks still valid

  # === Phase 6: Capture (knowledge) ===
  - id: capture-result
    stage: knowledge
    capabilities_needed: [cap-capture-card]
    output_type: improvement-log
    gate_requires: [gate-verdict]
    description: >
      Record annotation report:
      (1) Blocks annotated: count and list
      (2) Ghost caps resolved: count
      (3) New cap_ids introduced
      (4) Remaining unannotated blocks (if any)
      (5) Suggested follow-up actions

branches:
  - from: verify-annotations
    condition: "ALL annotations valid AND no regressions"
    goto: capture-result
    note: "All annotations applied successfully"
  - from: verify-annotations
    condition: "SOME validation failures AND iterations < max_iterations"
    goto: apply-frontmatter
    note: "Fix validation failures and retry"
  - from: verify-annotations
    condition: "iterations >= max_iterations"
    goto: capture-result
    note: "Budget exhausted — capture partial progress"
  - from: preview-annotations
    condition: "dry-run flag is set"
    goto: capture-result
    note: "Dry run — skip apply, just record preview"

applicable_policies:
  required:
    - rule-quality-deliverable-minimum
    - rule-improve-verify-result
    - rule-skill-build-gate
    - rule-completion-guard
  recommended: []

quality_standards:
  frontmatter_complete: "All annotated blocks have cap_id, input_types, output_types, leveling"
  naming_compliant: "All new cap_ids use controlled verbs and objects"
  no_duplicates: "No duplicate cap_ids across the system"
  index_consistent: "capability-index.yaml matches block frontmatter"
  registry_consistent: "skills-registry.yaml matches block frontmatter"

stop_rules:
  max_iterations: 2
  annotation_complete: "All target blocks annotated and validated"
  time_budget: "Configurable via --time flag (default 1h)"
completion_guard:
  enabled: true
  required_evidence: [gate-verdict, improvement-log]
  completion_promise: "ALL_STEPS_COMPLETE"
